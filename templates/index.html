<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¿èˆç¡çœ è®°å½•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .record { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; background-color: #f8f9fa; }
        #message { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { color: #6c757d; }
    </style>
</head>
<body>
    <h1>ğŸŒ™ æˆ‘çš„ç¡çœ è®°å½•</h1>
    
    <div class="container">
        <h3>æ·»åŠ ä»Šæ—¥è®°å½•</h3>
        <input type="time" id="sleepTime" required>
        <input type="date" id="recordDate">
        <button onclick="submitRecord()" id="submitBtn">æäº¤è®°å½•</button>
        <div id="message"></div>
    </div>

    <div class="container">
        <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
        <p>æ€»è®°å½•æ•°: <span id="totalRecords">0</span></p>
        <p>æ€»ç†¬å¤œæ—¶é—´: <span id="totalLateMinutes">0</span> åˆ†é’Ÿ</p>
        <button onclick="loadStats()">åˆ·æ–°ç»Ÿè®¡</button>
    </div>

    <div class="container">
        <h3>å†å²è®°å½•</h3>
        <div id="recordsList"></div>
        <button onclick="loadRecords()">åˆ·æ–°è®°å½•</button>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('recordDate').valueAsDate = new Date();

        async function submitRecord() {
            const time = document.getElementById('sleepTime').value;
            const date = document.getElementById('recordDate').value;
            const messageEl = document.getElementById('message');
            const submitBtn = document.getElementById('submitBtn');

            // æ¸…é™¤ä¹‹å‰çš„ä¿¡æ¯
            messageEl.textContent = '';
            messageEl.className = '';
            
            if (!time) {
                showMessage('è¯·é€‰æ‹©ç¡çœ æ—¶é—´ï¼', 'error');
                return;
            }

            console.log('æäº¤æ•°æ®:', { sleep_time: time, record_date: date });

            // ç¦ç”¨æäº¤æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                const response = await fetch('/api/records', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        sleep_time: time, 
                        record_date: date 
                    })
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                
                const result = await response.json();
                console.log('å“åº”æ•°æ®:', result);
                
                if (response.ok) {
                    showMessage(result.status || 'è®°å½•æˆåŠŸï¼', 'success');
                    loadRecords();
                    loadStats();
                    // æ¸…ç©ºæ—¶é—´è¾“å…¥
                    document.getElementById('sleepTime').value = '';
                } else {
                    showMessage(result.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            } catch (error) {
                console.error('æäº¤é”™è¯¯:', error);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ï¼', 'error');
            } finally {
                // é‡æ–°å¯ç”¨æäº¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤è®°å½•';
            }
        }

        async function loadRecords() {
            const listEl = document.getElementById('recordsList');
            listEl.innerHTML = '<p class="loading">åŠ è½½ä¸­...</p>';
            
            try {
                const response = await fetch('/api/records');
                if (!response.ok) {
                    throw new Error('è·å–è®°å½•å¤±è´¥');
                }
                const records = await response.json();
                
                if (records.length === 0) {
                    listEl.innerHTML = '<p>æš‚æ— è®°å½•</p>';
                } else {
                    listEl.innerHTML = records.map(record => 
                        `<div class="record">
                            <strong>æ—¥æœŸ:</strong> ${record.record_date} 
                            | <strong>ç¡çœ æ—¶é—´:</strong> ${record.sleep_time}
                        </div>`
                    ).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è®°å½•é”™è¯¯:', error);
                listEl.innerHTML = '<p class="error">åŠ è½½è®°å½•å¤±è´¥</p>';
            }
        }

        async function loadStats() {
            const totalRecordsEl = document.getElementById('totalRecords');
            const totalLateMinutesEl = document.getElementById('totalLateMinutes');
            
            totalRecordsEl.textContent = 'åŠ è½½ä¸­...';
            totalLateMinutesEl.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) {
                    throw new Error('è·å–ç»Ÿè®¡å¤±è´¥');
                }
                const stats = await response.json();
                totalRecordsEl.textContent = stats.total_records;
                totalLateMinutesEl.textContent = stats.total_late_minutes;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡é”™è¯¯:', error);
                totalRecordsEl.textContent = 'é”™è¯¯';
                totalLateMinutesEl.textContent = 'é”™è¯¯';
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = type;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–è®°å½•å’Œç»Ÿè®¡
        window.addEventListener('load', function() {
            loadRecords();
            loadStats();
        });

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitRecord();
            }
        });
    </script>
</body>
</html>
